<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazônia 1 | Chat LLM Brasileiro</title>
    <!-- Removendo Font Awesome problemático -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <!-- Firebase SDK mais recente -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

    <style>
        :root {
            --primary: #000000;
            --secondary: #111111;
            --accent: #0066CC;
            --accent-light: #0099FF;
            --accent-secondary: #00A86B;
            --accent-gradient: linear-gradient(135deg, #0066CC 0%, #004C99 100%);
            --accent-gradient-secondary: linear-gradient(135deg, #00A86B 0%, #008552 100%);
            --accent-gradient-hover: linear-gradient(135deg, #0055AA 0%, #003D7A 100%);
            --light: #FFFFFF;
            --light-secondary: #F8FAFC;
            --dark: #0F172A;
            --dark-secondary: #1E293B;
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-primary: #000000;
            --text-secondary: #475569;
            --text-tertiary: #94A3B8;
            --border: #E2E8F0;
            --shadow: 0 20px 60px rgba(0, 102, 204, 0.15);
            --shadow-hover: 0 30px 80px rgba(0, 102, 204, 0.25);
            --radius-lg: 28px;
            --radius-md: 20px;
            --radius-sm: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --error-color: #ef4444;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --user-message-bg: #0066CC;
            --assistant-message-bg: #F1F5F9;
            --typing-indicator-color: #94A3B8;
        }

        .dark-theme {
            --primary: #FFFFFF;
            --secondary: #F1F5F9;
            --light: #0F172A;
            --light-secondary: #1E293B;
            --card-bg: rgba(30, 41, 59, 0.95);
            --text-primary: #F1F5F9;
            --text-secondary: #CBD5E1;
            --text-tertiary: #64748B;
            --border: #334155;
            --shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            --shadow-hover: 0 30px 80px rgba(0, 0, 0, 0.4);
            --assistant-message-bg: #1E293B;
            --user-message-bg: #0066CC;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--light);
            color: var(--text-primary);
            line-height: 1.6;
            overflow: hidden;
            height: 100vh;
        }

        /* Login Modal */
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--light);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }

        .login-content {
            background: var(--light);
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 400px;
            box-shadow: var(--shadow-hover);
            overflow: hidden;
            animation: slideUp 0.5s ease-out;
        }

        .login-header {
            padding: 40px 40px 20px;
            text-align: center;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-secondary) 100%);
            color: white;
        }

        .login-header .logo {
            justify-content: center;
            margin-bottom: 20px;
            color: white;
        }

        .login-header h2 {
            font-weight: 700;
            font-size: 24px;
            margin-bottom: 10px;
        }

        .login-header p {
            opacity: 0.9;
            font-size: 15px;
        }

        .login-body {
            padding: 40px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .input-group input {
            width: 100%;
            padding: 16px;
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            background: var(--light);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 15px;
            transition: var(--transition);
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
        }

        .login-btn, .google-login-btn {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .login-btn {
            background: var(--accent-gradient);
            color: white;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .google-login-btn {
            background: white;
            color: var(--text-primary);
            border: 2px solid var(--border);
        }

        .google-login-btn:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .divider {
            text-align: center;
            margin: 20px 0;
            position: relative;
            color: var(--text-tertiary);
            font-size: 14px;
        }

        .divider::before, .divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 45%;
            height: 1px;
            background: var(--border);
        }

        .divider::before {
            left: 0;
        }

        .divider::after {
            right: 0;
        }

        .login-links {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .login-links a {
            color: var(--accent);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: var(--transition);
        }

        .login-links a:hover {
            color: var(--accent-light);
        }

        /* App Container */
        .app-container {
            display: flex;
            height: 100vh;
            position: relative;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--light);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            transform: translateX(-100%);
        }

        @media (min-width: 769px) {
            .sidebar {
                position: relative;
                transform: translateX(0);
            }
        }

        .sidebar.active {
            transform: translateX(0);
            box-shadow: 10px 0 30px rgba(0, 0, 0, 0.1);
        }

        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid var(--border);
            background: var(--light);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 900;
            font-size: 20px;
            color: var(--primary);
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--accent-gradient);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            flex-shrink: 0;
        }

        .logo-subtitle {
            font-size: 12px;
            font-weight: 600;
            color: var(--accent);
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-top: 2px;
        }

        .new-chat-btn {
            width: calc(100% - 40px);
            padding: 16px;
            margin: 20px;
            background: var(--accent-gradient);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            position: sticky;
            top: 104px;
            z-index: 5;
        }

        .new-chat-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .conversations-list {
            flex: 1;
            overflow-y: auto;
            padding: 0 20px 20px;
            margin-top: -20px;
            padding-top: 20px;
        }

        .conversation-item {
            padding: 14px 16px;
            border-radius: var(--radius-md);
            margin-bottom: 8px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-secondary);
            border: 1px solid transparent;
            position: relative;
        }

        .conversation-item:hover {
            background: var(--light-secondary);
            border-color: var(--border);
        }

        .conversation-item.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .conversation-item i {
            font-size: 14px;
            flex-shrink: 0;
        }

        .conversation-title {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 14px;
            min-width: 0;
        }

        .conversation-time {
            font-size: 12px;
            opacity: 0.7;
            flex-shrink: 0;
        }

        .user-section {
            padding: 20px;
            border-top: 1px solid var(--border);
            background: var(--light);
            position: sticky;
            bottom: 0;
            margin-top: auto;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: var(--accent-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            flex-shrink: 0;
        }

        .user-details {
            flex: 1;
            min-width: 0;
        }

        .user-name {
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-email {
            font-size: 12px;
            color: var(--text-tertiary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .logout-btn {
            background: none;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            padding: 8px;
            border-radius: var(--radius-sm);
            transition: var(--transition);
            flex-shrink: 0;
        }

        .logout-btn:hover {
            color: var(--error-color);
            background: rgba(239, 68, 68, 0.1);
        }

        /* Main Chat Area */
        .main-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--light-secondary);
            width: 100%;
        }

        .chat-header {
            padding: 16px 24px;
            background: var(--light);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 50;
            height: 72px;
        }

        .chat-title {
            font-weight: 700;
            font-size: 18px;
            color: var(--primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            margin-right: 16px;
        }

        .chat-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .action-btn {
            background: none;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-secondary);
            transition: var(--transition);
            flex-shrink: 0;
        }

        .action-btn:hover {
            background: var(--light-secondary);
            color: var(--accent);
        }

        .mobile-menu-btn {
            display: none;
        }

        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: flex;
            }
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            scroll-behavior: smooth;
        }

        .message {
            display: flex;
            gap: 16px;
            max-width: 800px;
            animation: fadeIn 0.3s ease-out;
            position: relative;
        }

        .message.assistant {
            align-self: flex-start;
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 14px;
            font-weight: 600;
        }

        .message.assistant .message-avatar {
            background: var(--accent-gradient);
            color: white;
        }

        .message.user .message-avatar {
            background: var(--text-tertiary);
            color: white;
        }

        .message-content {
            padding: 16px 20px;
            border-radius: var(--radius-lg);
            max-width: 85%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            position: relative;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .message.assistant .message-content {
            background: var(--assistant-message-bg);
            border-bottom-left-radius: 4px;
            color: var(--text-primary);
        }

        .message.user .message-content {
            background: var(--user-message-bg);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message-text {
            line-height: 1.6;
            font-size: 15px;
            font-feature-settings: "kern" 1, "liga" 1;
        }

        .message-text p {
            margin-bottom: 12px;
        }

        .message-text p:last-child {
            margin-bottom: 0;
        }

        .message-text pre {
            background: rgba(0, 0, 0, 0.1);
            padding: 12px;
            border-radius: var(--radius-sm);
            overflow-x: auto;
            margin: 12px 0;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            max-width: 100%;
        }

        .message-text code {
            background: rgba(0, 0, 0, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }

        .message.assistant .message-text pre {
            background: rgba(0, 0, 0, 0.05);
        }

        .message.assistant .message-text code {
            background: rgba(0, 0, 0, 0.05);
        }

        .message-time {
            font-size: 12px;
            margin-top: 8px;
            opacity: 0.7;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .message.user .message-time {
            justify-content: flex-end;
        }

        .message-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: var(--radius-md);
            margin-top: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: block;
            object-fit: contain;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 4px;
            align-items: center;
            justify-content: center;
            height: 24px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--typing-indicator-color);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        /* Input Area */
        .input-area {
            padding: 20px 24px;
            background: var(--light);
            border-top: 1px solid var(--border);
            position: sticky;
            bottom: 0;
            z-index: 40;
        }

        .image-preview {
            display: flex;
            gap: 0px;
            padding: 1px;
            margin-bottom: 12px;
            border-radius: var(--radius-md);
            background: var(--light-secondary);
            max-width: 100%;
            overflow-x: auto;
            min-height: 0px;
            align-items: center;
            scrollbar-width: thin;
        }

        .image-preview::-webkit-scrollbar {
            height: 6px;
        }

        .preview-item {
            position: relative;
            flex-shrink: 0;
            width: 80px;
            height: 80px;
        }

        .preview-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: var(--radius-sm);
        }

        .remove-image {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            background: var(--error-color);
            color: white;
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            transition: var(--transition);
            z-index: 2;
        }

        .remove-image:hover {
            transform: scale(1.1);
        }

        .input-container {
            position: relative;
            background: var(--light);
            border-radius: var(--radius-lg);
            border: 2px solid var(--border);
            transition: var(--transition);
            padding: 8px;
            display: flex;
            align-items: flex-end;
        }

        .input-container:focus-within {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
        }

        .text-input {
            flex: 1;
            min-height: 56px;
            max-height: 200px;
            padding: 16px 60px 16px 16px;
            border: none;
            background: none;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 15px;
            line-height: 1.5;
            resize: none;
            outline: none;
            overflow-y: auto;
        }

        .text-input::placeholder {
            color: var(--text-tertiary);
        }

        .input-actions {
            position: absolute;
            right: 16px;
            bottom: 16px;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .upload-btn, .send-btn {
            background: none;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            color: var(--text-tertiary);
        }

        .upload-btn:hover {
            background: var(--light-secondary);
            color: var(--accent);
        }

        .send-btn {
            background: var(--accent);
            color: white;
        }

        .send-btn:hover:not(:disabled) {
            background: var(--accent-light);
            transform: scale(1.05);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Settings Modal */
        .settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
            backdrop-filter: blur(4px);
        }

        .settings-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .settings-content {
            background: var(--light);
            border-radius: var(--radius-lg);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-hover);
            animation: slideUp 0.3s ease-out;
            margin: 20px;
        }

        .settings-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--light);
            z-index: 1;
        }

        .settings-title {
            font-weight: 700;
            font-size: 20px;
            color: var(--primary);
        }

        .close-settings {
            background: none;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-tertiary);
            transition: var(--transition);
        }

        .close-settings:hover {
            background: var(--light-secondary);
            color: var(--error-color);
        }

        .settings-body {
            padding: 24px;
        }

        .setting-group {
            margin-bottom: 24px;
        }

        .setting-label {
            display: block;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .setting-value {
            color: var(--accent);
            font-weight: 600;
            margin-left: 8px;
        }

        .slider-container {
            padding: 12px 0;
        }

        .slider {
            width: 100%;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 102, 204, 0.3);
            transition: var(--transition);
        }

        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }

        .select-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            background: var(--light);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 15px;
            transition: var(--transition);
            cursor: pointer;
        }

        .select-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
        }

        .save-settings {
            width: 100%;
            padding: 18px;
            background: var(--accent-gradient);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .save-settings:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        /* Welcome Screen */
        .welcome-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 24px;
            text-align: center;
            animation: fadeIn 0.8s ease-out;
        }

        .welcome-icon {
            width: 120px;
            height: 120px;
            background: var(--accent-gradient);
            border-radius: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 48px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
        }

        .welcome-title {
            font-weight: 800;
            font-size: 36px;
            color: var(--primary);
            margin-bottom: 16px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .welcome-subtitle {
            font-size: 18px;
            color: var(--text-secondary);
            max-width: 600px;
            margin-bottom: 40px;
            line-height: 1.6;
        }

        .capabilities {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            max-width: 800px;
            width: 100%;
            margin-bottom: 40px;
        }

        @media (max-width: 640px) {
            .capabilities {
                grid-template-columns: 1fr;
            }
        }

        .capability-item {
            background: var(--light);
            padding: 24px;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            transition: var(--transition);
            text-align: left;
        }

        .capability-item:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow);
        }

        .capability-icon {
            width: 48px;
            height: 48px;
            background: var(--accent-gradient);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            margin-bottom: 16px;
        }

        .capability-title {
            font-weight: 700;
            font-size: 16px;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .capability-desc {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* Overlay for mobile */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 99;
            backdrop-filter: blur(2px);
        }

        .sidebar-overlay.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        /* Loading states */
        .loading {
            display: inline-block;
            animation: spin 1s linear infinite;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            background: var(--success-color);
            color: white;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow);
            z-index: 1001;
            animation: slideInRight 0.3s ease-out;
            max-width: 400px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .notification.error {
            background: var(--error-color);
        }

        .notification.warning {
            background: var(--warning-color);
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--light-secondary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-tertiary);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.6; }
            30% { transform: translateY(-8px); opacity: 1; }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Utility classes */
        .hidden {
            display: none !important;
        }

        .flex-center {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: var(--text-tertiary);
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Formulários de Login/Registro */
        .login-form, .register-form {
            display: none;
        }

        .login-form.active, .register-form.active {
            display: block;
        }

        .toggle-form {
            text-align: center;
            margin-top: 20px;
            color: var(--text-tertiary);
            font-size: 14px;
        }

        .toggle-form a {
            color: var(--accent);
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
        }

        .toggle-form a:hover {
            color: var(--accent-light);
        }

        .error-message {
            color: var(--error-color);
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        .error-message.show {
            display: block;
        }
        /* Search bar */
        .search-container {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 84px;
            background: var(--light);
            z-index: 5;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px 12px 40px;
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            background: var(--light-secondary);
            color: var(--text-primary);
            font-size: 14px;
            transition: var(--transition);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--light);
        }

        .search-icon {
            position: absolute;
            left: 32px;
            top: 28px;
            color: var(--text-tertiary);
            pointer-events: none;
        }

        .conversation-actions {
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: var(--transition);
        }

        .conversation-item:hover .conversation-actions {
            opacity: 1;
        }

        .conversation-item.favorite {
            border-left: 3px solid var(--warning-color);
        }

        .action-icon-btn {
            background: none;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-tertiary);
            transition: var(--transition);
            flex-shrink: 0;
        }

        .action-icon-btn:hover {
            background: var(--light-secondary);
        }

        .action-icon-btn.favorite-btn:hover,
        .action-icon-btn.favorite-btn.active {
            color: var(--warning-color);
        }

        .action-icon-btn.delete-btn:hover {
            color: var(--error-color);
            background: rgba(239, 68, 68, 0.1);
        }

        .no-results {
            text-align: center;
            padding: 32px 24px;
            color: var(--text-tertiary);
            font-size: 14px;
        }

        .no-results i {
            font-size: 32px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        /* SUBSTITUA o CSS das mensagens e botões de ação por: */

        .message-content {
            padding: 16px 20px;
            border-radius: var(--radius-lg);
            max-width: 85%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            position: relative;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .message.assistant .message-content {
            background: var(--assistant-message-bg);
            border-bottom-left-radius: 4px;
            color: var(--text-primary);
        }

        .message.user .message-content {
            background: var(--user-message-bg);
            color: white;
            border-bottom-right-radius: 4px;
            padding-right: 48px; /* Espaço para o botão de excluir */
        }

        /* Botões de ação nas mensagens */
        .message-actions {
            margin-top: 12px;
            padding-top: 8px;
            border-top: 1px solid rgba(0,0,0,0.1);
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .dark-theme .message-actions {
            border-top-color: rgba(255,255,255,0.1);
        }

        .action-icon-btn.small {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 16px;
            background: var(--light-secondary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 4px;
            height: 28px;
            white-space: nowrap;
        }

        .action-icon-btn.small:hover {
            background: var(--border);
            color: var(--text-primary);
        }

        .action-icon-btn.small.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .action-icon-btn.small.delete-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 32px;
            height: 32px;
            padding: 0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.7;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .dark-theme .action-icon-btn.small.delete-btn {
            background: rgba(30, 41, 59, 0.9);
        }

        .action-icon-btn.small.delete-btn:hover {
            background: var(--error-color);
            color: white;
            border-color: var(--error-color);
            opacity: 1;
            transform: scale(1.05);
        }

        /* Botão de cancelar no typing indicator */
        #typingIndicator .message-content {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
        }

        #typingIndicator .typing-indicator {
            flex: 0 0 auto;
        }

        #typingIndicator #cancelGenerationBtn {
            margin-left: auto;
            flex-shrink: 0;
            padding: 6px 12px;
            height: 32px;
            font-size: 13px;
        }

        #typingIndicator #cancelGenerationBtn:hover {
            background: var(--error-color);
            color: white;
            border-color: var(--error-color);
        }

        /* Player de áudio */
        .audio-player {
            margin-bottom: 12px;
        }

        .audio-player audio {
            width: 100%;
            max-width: 300px;
            height: 32px;
            border-radius: 16px;
        }

        /* Ajustes para mensagens do assistente */
        .message.assistant .message-actions .action-icon-btn.small {
            background: rgba(0, 0, 0, 0.05);
        }

        .dark-theme .message.assistant .message-actions .action-icon-btn.small {
            background: rgba(255, 255, 255, 0.1);
        }

        .message.assistant .message-actions .action-icon-btn.small:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        .dark-theme .message.assistant .message-actions .action-icon-btn.small:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* Responsividade para mobile */
        @media (max-width: 640px) {
            .message-content {
                max-width: 90%;
            }

            .action-icon-btn.small {
                font-size: 11px;
                padding: 4px 8px;
                height: 26px;
            }

            .message.user .message-content {
                padding-right: 44px;
            }

            .action-icon-btn.small.delete-btn {
                width: 28px;
                height: 28px;
                top: 6px;
                right: 6px;
            }
        }


        /* SUBSTITUA TODO O CSS DE MENSAGENS POR ESTE: */

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 24px;
            scroll-behavior: smooth;
        }

        .message {
            display: flex;
            gap: 12px;
            max-width: 100%;
            animation: fadeIn 0.3s ease-out;
            position: relative;
        }

        .message.assistant {
            align-self: flex-start;
            margin-right: auto;
            max-width: 85%;
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
            margin-left: auto;
            max-width: 75%;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            min-width: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 14px;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .message.assistant .message-avatar {
            background: var(--accent-gradient);
            color: white;
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #64748B 0%, #475569 100%);
            color: white;
        }

        .message-content {
            flex: 1;
            padding: 16px 20px;
            border-radius: 20px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            position: relative;
            word-wrap: break-word;
            overflow-wrap: break-word;
            min-width: 0;
        }

        .message.assistant .message-content {
            background: var(--assistant-message-bg);
            border-bottom-left-radius: 6px;
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .message.user .message-content {
            background: var(--user-message-bg);
            color: white;
            border-bottom-right-radius: 6px;
        }

        .message-text {
            line-height: 1.6;
            font-size: 15px;
            font-feature-settings: "kern" 1, "liga" 1;
        }

        .message-text p {
            margin-bottom: 12px;
        }

        .message-text p:last-child {
            margin-bottom: 0;
        }

        .message-text pre {
            background: rgba(0, 0, 0, 0.1);
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 12px 0;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            max-width: 100%;
        }

        .message-text code {
            background: rgba(0, 0, 0, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }

        .message.assistant .message-text pre {
            background: rgba(0, 0, 0, 0.05);
        }

        .message.assistant .message-text code {
            background: rgba(0, 0, 0, 0.05);
        }

        .message.user .message-text pre,
        .message.user .message-text code {
            background: rgba(255, 255, 255, 0.2);
        }

        .message-time {
            font-size: 11px;
            margin-top: 8px;
            opacity: 0.6;
            display: flex;
            align-items: center;
            gap: 4px;
            font-weight: 500;
        }

        .message.user .message-time {
            justify-content: flex-end;
        }

        .message-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 12px;
            margin-top: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: block;
            object-fit: contain;
        }

        /* Botões de ação nas mensagens */
        .message-actions {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            align-items: center;
        }

        .dark-theme .message-actions {
            border-top-color: rgba(255, 255, 255, 0.08);
        }

        .message.user .message-actions {
            border-top-color: rgba(255, 255, 255, 0.2);
        }

        .action-icon-btn.small {
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 600;
            border-radius: 12px;
            background: transparent;
            border: 1.5px solid rgba(0, 0, 0, 0.1);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            height: 32px;
            white-space: nowrap;
        }

        .action-icon-btn.small i {
            font-size: 13px;
        }

        .action-icon-btn.small:hover {
            background: var(--light-secondary);
            border-color: var(--accent);
            color: var(--accent);
            transform: translateY(-1px);
        }

        .action-icon-btn.small.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .action-icon-btn.small.active:hover {
            background: var(--accent-light);
            border-color: var(--accent-light);
        }

        /* Botões específicos */
        .action-icon-btn.small:has(.fa-thumbs-up):hover,
        .action-icon-btn.small:has(.fa-thumbs-up).active {
            background: var(--success-color);
            border-color: var(--success-color);
            color: white;
        }

        .action-icon-btn.small:has(.fa-thumbs-down):hover,
        .action-icon-btn.small:has(.fa-thumbs-down).active {
            background: var(--error-color);
            border-color: var(--error-color);
            color: white;
        }

        .action-icon-btn.small:has(.fa-copy):hover {
            background: var(--accent-secondary);
            border-color: var(--accent-secondary);
            color: white;
        }

        .action-icon-btn.small:has(.fa-redo):hover {
            background: var(--warning-color);
            border-color: var(--warning-color);
            color: white;
        }

        /* Botão de excluir mensagem do usuário */
        .message.user .action-icon-btn.delete-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 28px;
            height: 28px;
            padding: 0;
            border-radius: 50%;
            background: white;
            border: 2px solid var(--border);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            opacity: 0;
            transition: all 0.2s ease;
            z-index: 10;
        }

        .message.user:hover .action-icon-btn.delete-btn {
            opacity: 1;
        }

        .message.user .action-icon-btn.delete-btn:hover {
            background: var(--error-color);
            border-color: var(--error-color);
            color: white;
            transform: scale(1.1);
        }

        .dark-theme .message.user .action-icon-btn.delete-btn {
            background: var(--dark-secondary);
            border-color: var(--border);
        }

        /* Ajustes para mensagens do assistente */
        .message.assistant .message-actions .action-icon-btn.small {
            border-color: rgba(0, 0, 0, 0.15);
        }

        .dark-theme .message.assistant .message-actions .action-icon-btn.small {
            border-color: rgba(255, 255, 255, 0.15);
        }

        /* Typing indicator melhorado */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 8px 0;
            align-items: center;
            justify-content: flex-start;
            height: auto;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--typing-indicator-color);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        #typingIndicator {
            max-width: 85%;
        }

        #typingIndicator .message-content {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 14px 18px;
        }

        #typingIndicator .typing-indicator {
            flex: 0 0 auto;
        }

        #typingIndicator #cancelGenerationBtn {
            margin-left: auto;
            flex-shrink: 0;
            padding: 6px 14px;
            height: 32px;
            font-size: 12px;
            font-weight: 600;
            border-radius: 12px;
            background: transparent;
            border: 1.5px solid var(--error-color);
            color: var(--error-color);
        }

        #typingIndicator #cancelGenerationBtn:hover {
            background: var(--error-color);
            color: white;
            transform: translateY(-1px);
        }

        /* Player de áudio melhorado */
        .audio-player {
            margin: 12px 0;
            padding: 12px;
            background: rgba(0, 0, 0, 0.03);
            border-radius: 12px;
        }

        .dark-theme .audio-player {
            background: rgba(255, 255, 255, 0.05);
        }

        .audio-player audio {
            width: 100%;
            max-width: 100%;
            height: 40px;
            border-radius: 20px;
        }

        /* Estados de erro */
        .message-content .error-indicator,
        .message-content .timeout-indicator {
            margin-top: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .message-content .error-indicator {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error-color);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .message-content .timeout-indicator {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
            border: 1px solid rgba(245, 158, 11, 0.2);
        }

        /* Responsividade aprimorada */
        @media (max-width: 768px) {
            .messages-container {
                padding: 16px;
                gap: 20px;
            }

            .message.assistant {
                max-width: 90%;
            }

            .message.user {
                max-width: 85%;
            }

            .message-avatar {
                width: 36px;
                height: 36px;
                min-width: 36px;
                font-size: 13px;
            }

            .message-content {
                padding: 14px 16px;
                border-radius: 18px;
            }

            .message-text {
                font-size: 14px;
            }

            .action-icon-btn.small {
                font-size: 11px;
                padding: 5px 10px;
                height: 28px;
                gap: 4px;
            }

            .action-icon-btn.small i {
                font-size: 12px;
            }

            .message.user .action-icon-btn.delete-btn {
                width: 26px;
                height: 26px;
                top: -6px;
                right: -6px;
            }
        }

        @media (max-width: 480px) {
            .message.assistant,
            .message.user {
                max-width: 95%;
            }

            .message-content {
                padding: 12px 14px;
            }

            .message-actions {
                gap: 4px;
            }
        }

        /* Animações aprimoradas */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.5;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 24px;
            scroll-behavior: smooth;
        }

        .message {
            display: flex;
            gap: 12px;
            max-width: 100%;
            animation: fadeIn 0.3s ease-out;
            position: relative;
        }

        .message.assistant {
            align-self: flex-start;
            margin-right: auto;
            max-width: 85%;
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
            margin-left: auto;
            max-width: 75%;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            min-width: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 14px;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .message.assistant .message-avatar {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-secondary) 100%);
            color: white;
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #64748B 0%, #475569 100%);
            color: white;
        }

        .message-content {
            flex: 1;
            padding: 16px 20px;
            border-radius: 20px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            position: relative;
            word-wrap: break-word;
            overflow-wrap: break-word;
            min-width: 0;
            border: 1px solid var(--border);
        }

        .message.assistant .message-content {
            background: var(--assistant-message-bg);
            border-bottom-left-radius: 6px;
            color: var(--text-primary);
        }

        .message.user .message-content {
            background: var(--accent);
            color: white;
            border-bottom-right-radius: 6px;
        }

        .message-text {
            line-height: 1.6;
            font-size: 15px;
        }

        /* Ações das mensagens */
        .message-actions {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            align-items: center;
        }

        .dark-theme .message-actions { border-top-color: rgba(255, 255, 255, 0.08); }
        .message.user .message-actions { border-top-color: rgba(255, 255, 255, 0.2); }

        .action-icon-btn.small {
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 600;
            border-radius: 12px;
            background: transparent;
            border: 1.5px solid rgba(0, 0, 0, 0.1);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            height: 32px;
            white-space: nowrap;
        }

        .action-icon-btn.small i { font-size: 13px; }

        .action-icon-btn.small:hover {
            background: var(--light-secondary);
            border-color: var(--accent);
            color: var(--accent);
            transform: translateY(-1px);
        }

        .action-icon-btn.small.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .action-icon-btn.small.active:hover {
            background: var(--accent-light);
            border-color: var(--accent-light);
        }

        /* Cores específicas por ícone */
        .action-icon-btn.small:has(.fa-thumbs-up):hover,
        .action-icon-btn.small:has(.fa-thumbs-up).active {
            background: var(--success-color);
            border-color: var(--success-color);
            color: white;
        }

        .action-icon-btn.small:has(.fa-thumbs-down):hover,
        .action-icon-btn.small:has(.fa-thumbs-down).active {
            background: var(--error-color);
            border-color: var(--error-color);
            color: white;
        }

        .action-icon-btn.small:has(.fa-copy):hover {
            background: var(--accent-secondary);
            border-color: var(--accent-secondary);
            color: white;
        }

        .action-icon-btn.small:has(.fa-redo):hover {
            background: var(--warning-color);
            border-color: var(--warning-color);
            color: white;
        }

        /* Botão de excluir (mensagem do usuário) */
        .message.user .action-icon-btn.delete-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 28px;
            height: 28px;
            padding: 0;
            border-radius: 50%;
            background: white;
            border: 2px solid var(--border);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            opacity: 0;
            transition: all 0.2s ease;
            z-index: 10;
        }

        .message.user:hover .action-icon-btn.delete-btn { opacity: 1; }

        .message.user .action-icon-btn.delete-btn:hover {
            background: var(--error-color);
            border-color: var(--error-color);
            color: white;
            transform: scale(1.1);
        }

        .dark-theme .message.user .action-icon-btn.delete-btn {
            background: var(--dark-secondary);
        }

        /* Indicadores de erro/timeout */
        .error-indicator, .timeout-indicator {
            margin-top: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .error-indicator {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error-color);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .timeout-indicator {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
            border: 1px solid rgba(245, 158, 11, 0.2);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>

</head>
<body>
<!-- Login/Register Modal -->
<div class="login-modal" id="loginModal">
    <div class="login-content">
        <div class="login-header">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-leaf"></i>
                </div>
                <div>
                    <div>Amazônia 1</div>
                    <div class="logo-subtitle">LLM BRASILEIRO</div>
                </div>
            </div>
            <h2 id="formTitle">Faça login para continuar</h2>
            <p id="formSubtitle">Acesse sua conta para usar o Amazônia 1 LLM</p>
        </div>
        <div class="login-body">
            <!-- Formulário de Login -->
            <div class="login-form active" id="loginForm">
                <div class="input-group">
                    <label for="loginEmail">E-mail</label>
                    <input type="email" id="loginEmail" placeholder="seu@email.com">
                    <div class="error-message" id="loginEmailError"></div>
                </div>
                <div class="input-group">
                    <label for="loginPassword">Senha</label>
                    <input type="password" id="loginPassword" placeholder="Sua senha">
                    <div class="error-message" id="loginPasswordError"></div>
                </div>
                <button class="login-btn" id="emailLoginBtn">Entrar com E-mail</button>
                <div class="divider">ou</div>
                <button class="google-login-btn" id="googleLoginBtn">
                    <i class="fab fa-google"></i> Entrar com Google
                </button>
                <div class="toggle-form">
                    Não tem uma conta? <a id="showRegister">Registre-se</a>
                </div>
            </div>

            <!-- Formulário de Registro -->
            <div class="register-form" id="registerForm">
                <div class="input-group">
                    <label for="registerName">Nome completo</label>
                    <input type="text" id="registerName" placeholder="Seu nome completo">
                    <div class="error-message" id="registerNameError"></div>
                </div>
                <div class="input-group">
                    <label for="registerEmail">E-mail</label>
                    <input type="email" id="registerEmail" placeholder="seu@email.com">
                    <div class="error-message" id="registerEmailError"></div>
                </div>
                <div class="input-group">
                    <label for="registerPassword">Senha (mínimo 6 caracteres)</label>
                    <input type="password" id="registerPassword" placeholder="Sua senha">
                    <div class="error-message" id="registerPasswordError"></div>
                </div>
                <div class="input-group">
                    <label for="registerConfirmPassword">Confirmar Senha</label>
                    <input type="password" id="registerConfirmPassword" placeholder="Confirme sua senha">
                    <div class="error-message" id="registerConfirmPasswordError"></div>
                </div>
                <button class="login-btn" id="registerBtn">Criar Conta</button>
                <div class="toggle-form">
                    Já tem uma conta? <a id="showLogin">Faça login</a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div class="settings-modal" id="settingsModal">
    <div class="settings-content">
        <div class="settings-header">
            <h2 class="settings-title">Configurações do Chat</h2>
            <button class="close-settings" id="closeSettings">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="settings-body">
            <div class="setting-group">
                <label class="setting-label">
                    Modelo de IA
                    <span class="setting-value" id="modelValue">Amazônia-1 Standard</span>
                </label>
                <select class="select-input" id="modelSelect">
                    <option value="amazonia-1-standard">Amazônia-1 Standard</option>
                    <option value="amazonia-1-pro">Amazônia-1 Pro</option>
                    <option value="amazonia-1-max">Amazônia-1 Max</option>
                </select>
            </div>

            <div class="setting-group">
                <label class="setting-label">
                    Temperatura (Criatividade)
                    <span class="setting-value" id="temperatureValue">0.7</span>
                </label>
                <div class="slider-container">
                    <input type="range" min="0" max="1" step="0.1" value="0.7" class="slider" id="temperatureSlider">
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--text-tertiary); margin-top: 8px;">
                    <span>Mais preciso</span>
                    <span>Mais criativo</span>
                </div>
            </div>

            <div class="setting-group">
                <label class="setting-label">
                    Tamanho do Contexto (mensagens)
                    <span class="setting-value" id="contextValue">8</span>
                </label>
                <div class="slider-container">
                    <input type="range" min="1" max="20" step="1" value="8" class="slider" id="contextSlider">
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--text-tertiary); margin-top: 8px;">
                    <span>Curto</span>
                    <span>Longo</span>
                </div>
            </div>

            <div class="setting-group">
                <label class="setting-label">
                    Tema
                    <span class="setting-value" id="themeValue">Claro</span>
                </label>
                <select class="select-input" id="themeSelect">
                    <option value="light">Claro</option>
                    <option value="dark">Escuro</option>
                    <option value="auto">Automático</option>
                </select>
            </div>

            <div class="setting-group">
                <label class="setting-label">
                    Idioma
                    <span class="setting-value" id="languageValue">Português</span>
                </label>
                <select class="select-input" id="languageSelect">
                    <option value="pt">Português</option>
                    <option value="en">Inglês</option>
                    <option value="es">Espanhol</option>
                </select>
            </div>

            <div class="setting-group">
                <label class="setting-label">
                    Velocidade de Resposta
                    <span class="setting-value" id="speedValue">Normal</span>
                </label>
                <div class="slider-container">
                    <input type="range" min="1" max="3" step="1" value="2" class="slider" id="speedSlider">
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--text-tertiary); margin-top: 8px;">
                    <span>Lento</span>
                    <span>Normal</span>
                    <span>Rápido</span>
                </div>
            </div>

            <div class="setting-group">
                <label class="setting-label">
                    Qualidade de Imagens
                    <span class="setting-value" id="imageQualityValue">Média</span>
                </label>
                <div class="slider-container">
                    <input type="range" min="1" max="3" step="1" value="2" class="slider" id="imageQualitySlider">
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--text-tertiary); margin-top: 8px;">
                    <span>Baixa</span>
                    <span>Média</span>
                    <span>Alta</span>
                </div>
            </div>

            <button class="save-settings" id="saveSettings">
                <i class="fas fa-save"></i> Salvar Configurações
            </button>
        </div>
    </div>
</div>

<!-- Sidebar Overlay for Mobile -->
<div class="sidebar-overlay" id="sidebarOverlay"></div>

<!-- Main App Container -->
<div class="app-container">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-leaf"></i>
                </div>
                <div>
                    <div>Amazônia 1</div>
                    <div class="logo-subtitle">LLM BRASILEIRO</div>
                </div>
            </div>
        </div>
        <button class="new-chat-btn" id="newChatBtn">
            <i class="fas fa-plus"></i> Nova Conversa
        </button>

        <div class="search-container">
            <i class="fas fa-search search-icon"></i>
            <input type="text" class="search-input" id="searchInput" placeholder="Buscar conversas...">
        </div>

        <div class="conversations-list" id="conversationsList">
            <!-- Conversas serão carregadas aqui -->
            <div class="empty-state" id="emptyConversations" style="display: none;">
                <i class="fas fa-comments"></i>
                <p>Nenhuma conversa ainda</p>
                <p style="font-size: 14px; margin-top: 8px;">Comece uma nova conversa para começar!</p>
            </div>
            <div class="no-results" id="noResults" style="display: none;">
                <i class="fas fa-search"></i>
                <p>Nenhuma conversa encontrada</p>
            </div>
        </div>
        <div class="user-section">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">
                    <!-- Avatar inicial -->
                </div>
                <div class="user-details">
                    <div class="user-name" id="userName">Carregando...</div>
                    <div class="user-email" id="userEmail"></div>
                </div>
                <button class="logout-btn" id="logoutBtn" title="Sair">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="main-chat">
        <div class="chat-header">
            <div class="chat-title" id="currentChatTitle">Nova Conversa</div>
            <div class="chat-actions">
                <button class="action-btn" id="settingsBtn" title="Configurações">
                    <i class="fas fa-cog"></i>
                </button>
                <button class="action-btn mobile-menu-btn" id="mobileMenuBtn">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>

        <div class="messages-container" id="messagesContainer">
            <!-- Welcome Screen -->
            <div class="welcome-screen" id="welcomeScreen">
                <div class="welcome-icon">
                    <i class="fas fa-leaf"></i>
                </div>
                <h1 class="welcome-title">Amazônia 1 LLM</h1>
                <p class="welcome-subtitle">
                    Um modelo de linguagem brasileiro, desenvolvido para compreender e gerar texto em Português com excelência.
                </p>

                <div class="capabilities">
                    <div class="capability-item">
                        <div class="capability-icon">
                            <i class="fas fa-code"></i>
                        </div>
                        <h3 class="capability-title">Geração de Código</h3>
                        <p class="capability-desc">Ajudo a escrever código em múltiplas linguagens de programação.</p>
                    </div>
                    <div class="capability-item">
                        <div class="capability-icon">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <h3 class="capability-title">Análise de Texto</h3>
                        <p class="capability-desc">Posso resumir, traduzir e analisar documentos extensos.</p>
                    </div>
                    <div class="capability-item">
                        <div class="capability-icon">
                            <i class="fas fa-brain"></i>
                        </div>
                        <h3 class="capability-title">Raciocínio Complexo</h3>
                        <p class="capability-desc">Resolvo problemas matemáticos e lógicos passo a passo.</p>
                    </div>
                    <div class="capability-item">
                        <div class="capability-icon">
                            <i class="fas fa-image"></i>
                        </div>
                        <h3 class="capability-title">Visão por Computador</h3>
                        <p class="capability-desc">Analiso imagens que você enviar e descrevo o que vejo.</p>
                    </div>
                </div>

                <p style="color: var(--text-secondary); margin-top: 20px; font-size: 15px;">
                    Comece digitando sua mensagem abaixo ou crie uma nova conversa.
                </p>
            </div>

        </div>

        <div class="input-area">
            <div class="image-preview" id="imagePreview"></div>
            <div class="input-container">
                <textarea
                        class="text-input"
                        id="messageInput"
                        placeholder="Digite sua mensagem aqui... Pressione Enter para enviar, Shift+Enter para nova linha"
                        rows="1"
                ></textarea>
                <div class="input-actions">
                    <input type="file" id="imageUpload" accept="image/*" multiple style="display: none;">
                    <button class="upload-btn" id="uploadBtn" title="Anexar imagem" type="button">
                        <i class="fas fa-image"></i>
                    </button>
                    <button class="send-btn" id="sendBtn" disabled type="button">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>

    </div>
</div>

<script>

    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyBP4gezIV5vRyf6DHJjezmGuGXvAcIbDZU",
        authDomain: "llm-ia-a4b9e.firebaseapp.com",
        projectId: "llm-ia-a4b9e",
        storageBucket: "llm-ia-a4b9e.firebasestorage.app",
        messagingSenderId: "841738797186",
        appId: "1:841738797186:web:c035f6e19c38219812749b",
        measurementId: "G-5PBX9F8FZP"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // DOM Elements
    const loginModal = document.getElementById('loginModal');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebarOverlay');
    const conversationsList = document.getElementById('conversationsList');
    const emptyConversations = document.getElementById('emptyConversations');
    const messagesContainer = document.getElementById('messagesContainer');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const imageUpload = document.getElementById('imageUpload');
    const imagePreview = document.getElementById('imagePreview');
    const newChatBtn = document.getElementById('newChatBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsModal = document.getElementById('settingsModal');
    const closeSettings = document.getElementById('closeSettings');
    const saveSettings = document.getElementById('saveSettings');
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const welcomeScreen = document.getElementById('welcomeScreen');
    const userAvatar = document.getElementById('userAvatar');
    const userName = document.getElementById('userName');
    const userEmail = document.getElementById('userEmail');
    const currentChatTitle = document.getElementById('currentChatTitle');

    // Login/Register elements
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const formTitle = document.getElementById('formTitle');
    const formSubtitle = document.getElementById('formSubtitle');
    const showRegister = document.getElementById('showRegister');
    const showLogin = document.getElementById('showLogin');
    const registerBtn = document.getElementById('registerBtn');
    const emailLoginBtn = document.getElementById('emailLoginBtn');
    const googleLoginBtn = document.getElementById('googleLoginBtn');

    // Settings elements
    const modelSelect = document.getElementById('modelSelect');
    const temperatureSlider = document.getElementById('temperatureSlider');
    const contextSlider = document.getElementById('contextSlider');
    const themeSelect = document.getElementById('themeSelect');
    const languageSelect = document.getElementById('languageSelect');
    const speedSlider = document.getElementById('speedSlider');
    const imageQualitySlider = document.getElementById('imageQualitySlider');
    const modelValue = document.getElementById('modelValue');
    const temperatureValue = document.getElementById('temperatureValue');
    const contextValue = document.getElementById('contextValue');
    const themeValue = document.getElementById('themeValue');
    const languageValue = document.getElementById('languageValue');
    const speedValue = document.getElementById('speedValue');
    const imageQualityValue = document.getElementById('imageQualityValue');
    const searchInput = document.getElementById('searchInput');
    const noResults = document.getElementById('noResults');

    // State
    let currentUser = null;
    let currentConversationId = null;
    let userPreferences = null;
    let uploadedImages = [];
    let isSending = false;
    let conversationListener = null;
    let messageListener = null;
    let conversationsListener = null;
    let currentRequestId = null;
    let isGenerating = false;
    let currentAudioRecorder = null;
    let isRecording = false;
    let initialLoadComplete = false;
    let isCreatingConversation = false;
    let aiResponseListener = null;
    let displayedMessageIds = new Set();
    let aiResponseListeners = new Map();

    // Initialize the app
    document.addEventListener('DOMContentLoaded', initializeApp);

    async function initializeApp() {
        try {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    loginModal.style.display = 'none';
                    await loadUserProfile();
                    initializeEventListeners();
                    setupMessageInput();
                    applyTheme(userPreferences.theme);

                    welcomeScreen.style.display = 'flex';
                    messagesContainer.innerHTML = '';
                    messagesContainer.appendChild(welcomeScreen);

                    await loadConversations();
                } else {
                    loginModal.style.display = 'flex';
                    showLoginForm();
                }
            });
        } catch (error) {
            console.error('Error initializing app:', error);
            showNotification('Erro ao inicializar o aplicativo', 'error');
        }
    }

    // Form switching functions
    function showLoginForm() {
        loginForm.classList.add('active');
        registerForm.classList.remove('active');
        formTitle.textContent = 'Faça login para continuar';
        formSubtitle.textContent = 'Acesse sua conta para usar o Amazônia 1 LLM';
        clearErrors();
    }

    function showRegisterForm() {
        loginForm.classList.remove('active');
        registerForm.classList.add('active');
        formTitle.textContent = 'Crie sua conta';
        formSubtitle.textContent = 'Registre-se para usar o Amazônia 1 LLM';
        clearErrors();
    }

    function clearErrors() {
        const errorMessages = document.querySelectorAll('.error-message');
        errorMessages.forEach(msg => msg.classList.remove('show'));
    }

    function validateEmail(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email);
    }

    // Event Listeners for form switching
    showRegister.addEventListener('click', showRegisterForm);
    showLogin.addEventListener('click', showLoginForm);

    // Registration function
    registerBtn.addEventListener('click', async () => {
        const name = document.getElementById('registerName').value.trim();
        const email = document.getElementById('registerEmail').value.trim();
        const password = document.getElementById('registerPassword').value;
        const confirmPassword = document.getElementById('registerConfirmPassword').value;

        let isValid = true;
        clearErrors();

        if (!name) {
            document.getElementById('registerNameError').textContent = 'Nome é obrigatório';
            document.getElementById('registerNameError').classList.add('show');
            isValid = false;
        }

        if (!email) {
            document.getElementById('registerEmailError').textContent = 'E-mail é obrigatório';
            document.getElementById('registerEmailError').classList.add('show');
            isValid = false;
        } else if (!validateEmail(email)) {
            document.getElementById('registerEmailError').textContent = 'E-mail inválido';
            document.getElementById('registerEmailError').classList.add('show');
            isValid = false;
        }

        if (!password) {
            document.getElementById('registerPasswordError').textContent = 'Senha é obrigatória';
            document.getElementById('registerPasswordError').classList.add('show');
            isValid = false;
        } else if (password.length < 6) {
            document.getElementById('registerPasswordError').textContent = 'Senha deve ter no mínimo 6 caracteres';
            document.getElementById('registerPasswordError').classList.add('show');
            isValid = false;
        }

        if (!confirmPassword) {
            document.getElementById('registerConfirmPasswordError').textContent = 'Confirme sua senha';
            document.getElementById('registerConfirmPasswordError').classList.add('show');
            isValid = false;
        } else if (password !== confirmPassword) {
            document.getElementById('registerConfirmPasswordError').textContent = 'As senhas não coincidem';
            document.getElementById('registerConfirmPasswordError').classList.add('show');
            isValid = false;
        }

        if (!isValid) return;

        try {
            const userCredential = await auth.createUserWithEmailAndPassword(email, password);
            await userCredential.user.updateProfile({ displayName: name });

            await db.collection('users').doc(userCredential.user.uid).set({
                uid: userCredential.user.uid,
                name: name,
                email: email,
                preferences: {
                    theme: 'light',
                    language: 'pt',
                    model: 'amazonia-1-standard',
                    temperature: 0.7,
                    contextSize: 8,
                    responseSpeed: 2,
                    imageQuality: 2
                },
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            showNotification('Conta criada com sucesso!', 'success');
        } catch (error) {
            console.error('Error creating account:', error);
            let errorMessage = 'Erro ao criar conta';
            switch (error.code) {
                case 'auth/email-already-in-use':
                    errorMessage = 'Este e-mail já está em uso';
                    document.getElementById('registerEmailError').textContent = errorMessage;
                    document.getElementById('registerEmailError').classList.add('show');
                    break;
                case 'auth/invalid-email':
                    errorMessage = 'E-mail inválido';
                    document.getElementById('registerEmailError').textContent = errorMessage;
                    document.getElementById('registerEmailError').classList.add('show');
                    break;
                case 'auth/weak-password':
                    errorMessage = 'Senha muito fraca';
                    document.getElementById('registerPasswordError').textContent = errorMessage;
                    document.getElementById('registerPasswordError').classList.add('show');
                    break;
                default:
                    showNotification(errorMessage + ': ' + error.message, 'error');
            }
        }
    });

    // Login Functions
    emailLoginBtn.addEventListener('click', async () => {
        const email = document.getElementById('loginEmail').value.trim();
        const password = document.getElementById('loginPassword').value;

        clearErrors();

        if (!email) {
            document.getElementById('loginEmailError').textContent = 'E-mail é obrigatório';
            document.getElementById('loginEmailError').classList.add('show');
            return;
        }

        if (!password) {
            document.getElementById('loginPasswordError').textContent = 'Senha é obrigatória';
            document.getElementById('loginPasswordError').classList.add('show');
            return;
        }

        try {
            await auth.signInWithEmailAndPassword(email, password);
            showNotification('Login realizado com sucesso!', 'success');
        } catch (error) {
            console.error('Error signing in:', error);
            let errorMessage = 'Erro ao fazer login';
            switch (error.code) {
                case 'auth/user-not-found':
                case 'auth/wrong-password':
                    errorMessage = 'E-mail ou senha incorretos';
                    document.getElementById('loginEmailError').textContent = errorMessage;
                    document.getElementById('loginEmailError').classList.add('show');
                    break;
                case 'auth/invalid-email':
                    errorMessage = 'E-mail inválido';
                    document.getElementById('loginEmailError').textContent = errorMessage;
                    document.getElementById('loginEmailError').classList.add('show');
                    break;
                default:
                    showNotification(errorMessage + ': ' + error.message, 'error');
            }
        }
    });

    googleLoginBtn.addEventListener('click', async () => {
        const provider = new firebase.auth.GoogleAuthProvider();

        try {
            const result = await auth.signInWithPopup(provider);
            const user = result.user;

            if (result.additionalUserInfo.isNewUser) {
                await db.collection('users').doc(user.uid).set({
                    uid: user.uid,
                    name: user.displayName,
                    email: user.email,
                    photoURL: user.photoURL,
                    preferences: {
                        theme: 'light',
                        language: 'pt',
                        model: 'amazonia-1-standard',
                        temperature: 0.7,
                        contextSize: 8,
                        responseSpeed: 2,
                        imageQuality: 2
                    },
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }

            showNotification('Login com Google realizado com sucesso!', 'success');
        } catch (error) {
            console.error('Error signing in with Google:', error);
            showNotification('Erro ao fazer login com Google: ' + error.message, 'error');
        }
    });

    async function loadUserProfile() {
        try {
            const userDoc = await db.collection('users').doc(currentUser.uid).get();

            if (!userDoc.exists) {
                userPreferences = {
                    theme: 'light',
                    language: 'pt',
                    model: 'amazonia-1-standard',
                    temperature: 0.7,
                    contextSize: 8,
                    responseSpeed: 2,
                    imageQuality: 2
                };

                await db.collection('users').doc(currentUser.uid).set({
                    uid: currentUser.uid,
                    name: currentUser.displayName || currentUser.email.split('@')[0],
                    email: currentUser.email,
                    photoURL: currentUser.photoURL || null,
                    preferences: userPreferences,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            } else {
                const userData = userDoc.data();
                userPreferences = userData.preferences || {
                    theme: 'light',
                    language: 'pt',
                    model: 'amazonia-1-standard',
                    temperature: 0.7,
                    contextSize: 8,
                    responseSpeed: 2,
                    imageQuality: 2
                };
            }

            const userData = (await db.collection('users').doc(currentUser.uid).get()).data();
            const initials = getInitials(userData.name || currentUser.email);
            userAvatar.textContent = initials;
            userName.textContent = userData.name || currentUser.email.split('@')[0];
            userEmail.textContent = currentUser.email;

            updateSettingsUI();
        } catch (error) {
            console.error('Error loading user profile:', error);
            showNotification('Erro ao carregar perfil do usuário', 'error');
        }
    }

    function updateSettingsUI() {
        if (!userPreferences) return;

        modelSelect.value = userPreferences.model;
        temperatureSlider.value = userPreferences.temperature;
        contextSlider.value = userPreferences.contextSize;
        themeSelect.value = userPreferences.theme;
        languageSelect.value = userPreferences.language;
        speedSlider.value = userPreferences.responseSpeed || 2;
        imageQualitySlider.value = userPreferences.imageQuality || 2;
        updateSettingValues();
    }

    function applyTheme(theme) {
        const body = document.body;
        if (theme === 'dark') {
            body.classList.add('dark-theme');
        } else if (theme === 'auto') {
            if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                body.classList.add('dark-theme');
            } else {
                body.classList.remove('dark-theme');
            }
        } else {
            body.classList.remove('dark-theme');
        }
    }

    async function toggleFavorite(conversationId, isFavorite) {
        try {
            await db.collection('conversations').doc(conversationId).update({
                favorite: isFavorite,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            showNotification(
                isFavorite ? 'Conversa adicionada aos favoritos' : 'Conversa removida dos favoritos',
                'success'
            );
        } catch (error) {
            console.error('Error toggling favorite:', error);
            showNotification('Erro ao atualizar favorito', 'error');
        }
    }

    async function deleteConversation(conversationId) {
        if (!confirm('Tem certeza que deseja excluir esta conversa? Esta ação não pode ser desfeita.')) {
            return;
        }

        try {
            const messagesSnapshot = await db.collection('conversations')
                .doc(conversationId)
                .collection('messages')
                .get();

            const batch = db.batch();
            messagesSnapshot.forEach(doc => batch.delete(doc.ref));
            await batch.commit();

            await db.collection('conversations').doc(conversationId).delete();

            if (currentConversationId === conversationId) {
                currentConversationId = null;
                messagesContainer.innerHTML = '';
                welcomeScreen.style.display = 'flex';
                messagesContainer.appendChild(welcomeScreen);
                currentChatTitle.textContent = 'Nova Conversa';
            }

            showNotification('Conversa excluída com sucesso', 'success');
        } catch (error) {
            console.error('Error deleting conversation:', error);
            showNotification('Erro ao excluir conversa', 'error');
        }
    }

    function searchConversations(searchTerm) {
        const term = searchTerm.toLowerCase().trim();
        const conversationItems = conversationsList.querySelectorAll('.conversation-item');
        let visibleCount = 0;

        conversationItems.forEach(item => {
            const title = item.dataset.title || '';
            if (title.includes(term)) {
                item.style.display = 'flex';
                visibleCount++;
            } else {
                item.style.display = 'none';
            }
        });

        if (visibleCount === 0 && term !== '') {
            noResults.style.display = 'block';
            emptyConversations.style.display = 'none';
        } else {
            noResults.style.display = 'none';
            if (visibleCount === 0 && term === '') {
                emptyConversations.style.display = 'flex';
            } else {
                emptyConversations.style.display = 'none';
            }
        }
    }

    function addConversationToUI(id, conversation) {
        try {
            console.log('addConversationToUI: Adicionando conversa', id, conversation.title);

            // Verificar se já existe
            const existingItem = document.querySelector(`.conversation-item[data-id="${id}"]`);
            if (existingItem) {
                console.log('addConversationToUI: Conversa já existe, removendo...');
                existingItem.remove();
            }

            const conversationItem = document.createElement('div');
            conversationItem.className = `conversation-item ${conversation.favorite ? 'favorite' : ''}`;
            conversationItem.dataset.id = id;
            conversationItem.dataset.title = (conversation.title || 'Nova Conversa').toLowerCase();

            // Formatar tempo
            let timeStr = '';
            try {
                if (conversation.updatedAt) {
                    let time;
                    if (conversation.updatedAt.toDate) {
                        time = conversation.updatedAt.toDate();
                    } else if (conversation.updatedAt._seconds) {
                        time = new Date(conversation.updatedAt._seconds * 1000);
                    } else {
                        time = new Date(conversation.updatedAt);
                    }
                    timeStr = formatTime(time);
                }
            } catch (e) {
                console.warn('addConversationToUI: Erro ao formatar tempo:', e);
                timeStr = '';
            }

            const title = conversation.title || 'Nova Conversa';
            const truncatedTitle = title.length > 25 ? title.substring(0, 25) + '...' : title;

            conversationItem.innerHTML = `
            <i class="fas fa-comment"></i>
            <div class="conversation-title" title="${title}">${truncatedTitle}</div>
            <div class="conversation-time">${timeStr}</div>
            <div class="conversation-actions">
                <button class="action-icon-btn favorite-btn ${conversation.favorite ? 'active' : ''}"
                        data-id="${id}"
                        title="${conversation.favorite ? 'Remover dos favoritos' : 'Adicionar aos favoritos'}">
                    <i class="fas fa-star"></i>
                </button>
                <button class="action-icon-btn delete-btn"
                        data-id="${id}"
                        title="Excluir conversa">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;

            // Adicionar evento de clique na conversa (exceto nos botões)
            conversationItem.addEventListener('click', (e) => {
                // Não disparar se clicou nos botões de ação
                if (e.target.closest('.conversation-actions')) {
                    return;
                }
                console.log('addConversationToUI: Clicou na conversa', id);
                loadConversation(id);
            });

            // Adicionar eventos dos botões
            const favoriteBtn = conversationItem.querySelector('.favorite-btn');
            if (favoriteBtn) {
                favoriteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    console.log('addConversationToUI: Alternando favorito para', id);
                    const isCurrentlyFavorite = conversation.favorite || false;
                    toggleFavorite(id, !isCurrentlyFavorite);
                });
            }

            const deleteBtn = conversationItem.querySelector('.delete-btn');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    console.log('addConversationToUI: Deletando conversa', id);
                    deleteConversation(id);
                });
            }

            // Adicionar à lista
            conversationsList.appendChild(conversationItem);

            console.log('addConversationToUI: Conversa adicionada com sucesso:', id);

        } catch (error) {
            console.error('addConversationToUI: Erro ao adicionar conversa:', id, error);
        }
    }
    async function loadConversation(conversationId) {
        try {
            console.log('loadConversation chamado para:', conversationId);

            // 1. Limpar listeners anteriores
            if (messageListener) {
                console.log('Removendo listener anterior de mensagens');
                messageListener();
                messageListener = null;
            }

            aiResponseListeners.forEach(unsubscribe => unsubscribe());
            aiResponseListeners.clear();

            // 2. Atualizar estado
            currentConversationId = conversationId;

            // IMPORTANTE: Limpar o Set APÓS carregar as mensagens históricas
            // Vamos limpar agora, mas só vamos adicionar IDs depois de exibi-las
            displayedMessageIds.clear();

            // 3. Estado de loading
            messagesContainer.innerHTML = `
            <div class="empty-state">
                <div class="loading"><i class="fas fa-spinner fa-spin"></i></div>
                <p>Carregando conversa...</p>
            </div>
        `;
            welcomeScreen.style.display = 'none';

            // 4. Carregar metadados da conversa
            const conversationDoc = await db.collection('conversations').doc(conversationId).get();
            if (!conversationDoc.exists) {
                console.error('Conversa não encontrada:', conversationId);
                showNotification('Conversa não encontrada', 'error');
                return;
            }
            const conversation = conversationDoc.data();
            currentChatTitle.textContent = conversation.title || 'Nova Conversa';

            // 5. Carregar mensagens históricas
            const messagesQuery = db.collection('conversations')
                .doc(conversationId)
                .collection('messages')
                .orderBy('timestamp', 'asc');

            const messagesSnapshot = await messagesQuery.get();

            console.log('Total de mensagens históricas encontradas:', messagesSnapshot.size);

            // Limpar container
            messagesContainer.innerHTML = '';

            if (messagesSnapshot.empty) {
                welcomeScreen.style.display = 'flex';
                messagesContainer.appendChild(welcomeScreen);
            } else {
                // Primeiro: adicionar TODAS as mensagens ao DOM
                messagesSnapshot.docs.forEach(doc => {
                    const messageData = doc.data();
                    const message = {
                        id: doc.id,
                        ...messageData,
                        timestamp: messageData.timestamp?.toDate?.() || new Date()
                    };

                    // Adicionar ao DOM (sem animação)
                    addMessageToUI(message, false);
                });

                // Só agora, depois de todas exibidas, marcar como exibidas
                messagesSnapshot.docs.forEach(doc => {
                    displayedMessageIds.add(doc.id);
                });

                console.log('Mensagens históricas exibidas e marcadas:', displayedMessageIds.size);

                // Scroll para o final
                setTimeout(() => scrollToBottom(), 100);
            }

            // 6. Configurar listener apenas para NOVAS mensagens (futuras)
            messageListener = messagesQuery.onSnapshot((snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'added') {
                        const doc = change.doc;
                        const messageId = doc.id;

                        // Ignorar mensagens já exibidas (ou seja, as do carregamento inicial)
                        if (displayedMessageIds.has(messageId)) {
                            return;
                        }

                        const messageData = doc.data();
                        const message = {
                            id: messageId,
                            ...messageData,
                            timestamp: messageData.timestamp?.toDate?.() || new Date()
                        };

                        displayedMessageIds.add(messageId);
                        addMessageToUI(message, true); // com animação
                    }
                });

                scrollToBottom();
            }, (error) => {
                console.error('Error listening to messages:', error);
                showNotification('Erro ao ouvir novas mensagens', 'error');
            });

            // 7. Atualizações finais de UI
            updateActiveConversation();

            if (window.innerWidth <= 768) {
                sidebar.classList.remove('active');
                sidebarOverlay.classList.remove('active');
            }

            setTimeout(() => messageInput.focus(), 100);

            console.log('loadConversation concluído com sucesso');

        } catch (error) {
            console.error('Error loading conversation:', error);
            showNotification('Erro ao carregar conversa', 'error');

            messagesContainer.innerHTML = '';
            welcomeScreen.style.display = 'flex';
            messagesContainer.appendChild(welcomeScreen);
        }
    }
    function updateActiveConversation() {
        document.querySelectorAll('.conversation-item').forEach(item => {
            item.classList.remove('active');
            if (item.dataset.id === currentConversationId) {
                item.classList.add('active');
            }
        });
    }

    async function uploadImageToStorage(file) {
        try {
            const storageRef = storage.ref();
            const imageRef = storageRef.child(`users/${currentUser.uid}/images/${Date.now()}_${file.name}`);
            const snapshot = await imageRef.put(file);
            const downloadURL = await snapshot.ref.getDownloadURL();
            return downloadURL;
        } catch (error) {
            console.error('Error uploading image:', error);
            throw error;
        }
    }

    function handleResize() {
        if (window.innerWidth > 768) {
            sidebar.classList.remove('active');
            sidebarOverlay.classList.remove('active');
        }
    }

    function handleImageUpload(event) {
        const files = Array.from(event.target.files);
        if (files.length === 0) return;

        const maxSize = 5 * 1024 * 1024;
        const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];

        for (const file of files) {
            if (!allowedTypes.includes(file.type)) {
                showNotification(`Tipo de arquivo não suportado: ${file.name}`, 'error');
                continue;
            }

            if (file.size > maxSize) {
                showNotification(`Arquivo muito grande (máx. 5MB): ${file.name}`, 'error');
                continue;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const previewItem = document.createElement('div');
                previewItem.className = 'preview-item';

                previewItem.innerHTML = `
                <img src="${e.target.result}" alt="${file.name}" class="preview-image">
                <button class="remove-image" data-name="${file.name}">
                    <i class="fas fa-times"></i>
                </button>
            `;

                imagePreview.appendChild(previewItem);

                previewItem.querySelector('.remove-image').addEventListener('click', function() {
                    const name = this.dataset.name;
                    uploadedImages = uploadedImages.filter(img => img.name !== name);
                    previewItem.remove();
                    updateSendButtonState();
                });
            };
            reader.readAsDataURL(file);

            uploadedImages.push({
                name: file.name,
                file: file,
                url: null
            });
        }

        event.target.value = '';
        updateSendButtonState();
    }

    function formatMessageContent(content) {
        if (!content) return '';

        let formatted = content.replace(/```(\w+)?\n([\s\S]*?)```/g,
            (match, lang, code) => `<pre><code class="language-${lang || ''}">${escapeHtml(code.trim())}</code></pre>`
        );

        formatted = formatted.replace(/`([^`]+)`/g, '<code>$1</code>');
        formatted = formatted.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');

        const paragraphs = formatted.split('\n\n');
        return paragraphs.map(p => {
            if (p.startsWith('<pre>') || p.startsWith('<')) {
                return p;
            }
            return `<p>${p.replace(/\n/g, '<br>')}</p>`;
        }).join('');
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function scrollToBottom() {
        requestAnimationFrame(() => {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        });
    }

    function generateId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
    }

    function getInitials(name) {
        if (!name) return 'U';
        return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
    }

    function updateSettingValues() {
        temperatureValue.textContent = temperatureSlider.value;
        contextValue.textContent = contextSlider.value;
        const speeds = ['Lento', 'Normal', 'Rápido'];
        speedValue.textContent = speeds[speedSlider.value - 1];
        const qualities = ['Baixa', 'Média', 'Alta'];
        imageQualityValue.textContent = qualities[imageQualitySlider.value - 1];
        const selectedModel = modelSelect.options[modelSelect.selectedIndex];
        modelValue.textContent = selectedModel.text;
        const selectedTheme = themeSelect.options[themeSelect.selectedIndex];
        themeValue.textContent = selectedTheme.text;
        const selectedLanguage = languageSelect.options[languageSelect.selectedIndex];
        languageValue.textContent = selectedLanguage.text;
    }

    function showNotification(message, type = 'info') {
        const existingNotification = document.querySelector('.notification');
        if (existingNotification) {
            existingNotification.remove();
        }

        const notification = document.createElement('div');
        notification.className = `notification ${type}`;

        const icon = type === 'success' ? 'fa-check-circle' :
            type === 'error' ? 'fa-exclamation-circle' :
                type === 'warning' ? 'fa-exclamation-triangle' :
                    'fa-info-circle';

        notification.innerHTML = `
        <i class="fas ${icon}"></i>
        <span>${message}</span>
    `;

        document.body.appendChild(notification);

        setTimeout(() => {
            notification.style.animation = 'slideInRight 0.3s ease-out reverse';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    async function cancelGeneration() {
        if (currentRequestId && isGenerating) {
            try {
                await db.collection('ai_requests').doc(currentRequestId).update({
                    status: 'cancelled',
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showNotification('Geração cancelada', 'info');
            } catch (error) {
                console.error('Error cancelling generation:', error);
            }

            currentRequestId = null;
            isGenerating = false;
            removeTypingIndicator();
            updateSendButtonState();
        }
    }

    async function regenerateLastMessage() {
        if (!currentConversationId) return;

        try {
            const messagesSnapshot = await db.collection('conversations')
                .doc(currentConversationId)
                .collection('messages')
                .orderBy('timestamp', 'desc')
                .where('role', '==', 'user')
                .limit(1)
                .get();

            if (!messagesSnapshot.empty) {
                const lastUserMessage = messagesSnapshot.docs[0].data();

                const assistantMessagesSnapshot = await db.collection('conversations')
                    .doc(currentConversationId)
                    .collection('messages')
                    .orderBy('timestamp', 'desc')
                    .where('role', '==', 'assistant')
                    .limit(1)
                    .get();

                if (!assistantMessagesSnapshot.empty) {
                    const lastAssistantMessage = assistantMessagesSnapshot.docs[0];
                    await lastAssistantMessage.ref.delete();
                }

                await sendMessageFromHistory(lastUserMessage);
            }
        } catch (error) {
            console.error('Error regenerating message:', error);
            showNotification('Erro ao gerar novamente', 'error');
        }
    }

    function addMessageActions(messageDiv, message) {
        if (message.role === 'assistant') {
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'message-actions';

            actionsDiv.innerHTML = `
      <button class="action-icon-btn small ${message.feedback === 'like' ? 'active' : ''}"
              onclick="handleFeedback('${message.id}', 'like')"
              title="Gostei da resposta">
        <i class="fas fa-thumbs-up"></i>

      </button>
      <button class="action-icon-btn small ${message.feedback === 'dislike' ? 'active' : ''}"
              onclick="handleFeedback('${message.id}', 'dislike')"
              title="Não gostei da resposta">
        <i class="fas fa-thumbs-down"></i>
      </button>
      <button class="action-icon-btn small"
              onclick="regenerateLastMessage()"
              title="Gerar nova resposta">
        <i class="fas fa-redo"></i>
      </button>
      <button class="action-icon-btn small"
              onclick="copyToClipboard(\`${message.content.replace(/`/g, '\\`')}\`)"
              title="Copiar resposta">
        <i class="fas fa-copy"></i>
      </button>
    `;

            const messageContent = messageDiv.querySelector('.message-content');
            messageContent.appendChild(actionsDiv);

            // Indicadores de erro ou timeout
            if (message.status === 'error') {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-indicator';
                errorDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> Erro ao processar';
                messageContent.insertBefore(errorDiv, actionsDiv);
            } else if (message.status === 'timeout') {
                const timeoutDiv = document.createElement('div');
                timeoutDiv.className = 'timeout-indicator';
                timeoutDiv.innerHTML = '<i class="fas fa-clock"></i> Tempo esgotado';
                messageContent.insertBefore(timeoutDiv, actionsDiv);
            }
        }
        else if (message.role === 'user') {
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'action-icon-btn small delete-btn';
            deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
            deleteBtn.title = 'Excluir esta mensagem';
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                deleteSpecificMessage(message.id);
            };
            messageDiv.appendChild(deleteBtn);
        }
    }
    async function deleteSpecificMessage(messageId) {
        if (!confirm('Tem certeza que deseja excluir esta mensagem?')) return;

        try {
            await db.collection('conversations')
                .doc(currentConversationId)
                .collection('messages')
                .doc(messageId)
                .delete();

            showNotification('Mensagem excluída', 'success');
        } catch (error) {
            console.error('Error deleting message:', error);
            showNotification('Erro ao excluir mensagem', 'error');
        }
    }

    async function handleFeedback(messageId, feedbackType) {
        try {
            // Verificar se é uma mensagem do assistant
            const messageDoc = await db.collection('conversations')
                .doc(currentConversationId)
                .collection('messages')
                .doc(messageId)
                .get();

            if (!messageDoc.exists) {
                showNotification('Mensagem não encontrada', 'error');
                return;
            }

            const messageData = messageDoc.data();

            // Verificar se o usuário é o dono da conversa
            const conversationDoc = await db.collection('conversations')
                .doc(currentConversationId)
                .get();

            if (!conversationDoc.exists) {
                showNotification('Conversa não encontrada', 'error');
                return;
            }

            const conversationData = conversationDoc.data();

            if (conversationData.userId !== currentUser.uid) {
                showNotification('Permissão negada para atualizar feedback', 'error');
                return;
            }

            // Atualizar feedback da mensagem
            await db.collection('conversations')
                .doc(currentConversationId)
                .collection('messages')
                .doc(messageId)
                .update({
                    feedback: feedbackType,
                    feedbackAt: firebase.firestore.FieldValue.serverTimestamp(),
                    feedbackBy: currentUser.uid
                });

            showNotification(`Feedback ${feedbackType === 'like' ? 'positivo' : 'negativo'} registrado`, 'success');

            // Atualizar UI
            const messageDiv = document.querySelector(`.message[data-id="${messageId}"]`);
            if (messageDiv) {
                const likeBtn = messageDiv.querySelector('.fa-thumbs-up')?.closest('button');
                const dislikeBtn = messageDiv.querySelector('.fa-thumbs-down')?.closest('button');

                if (likeBtn) likeBtn.classList.toggle('active', feedbackType === 'like');
                if (dislikeBtn) dislikeBtn.classList.toggle('active', feedbackType === 'dislike');
            }
        } catch (error) {
            console.error('Error saving feedback:', error);
            showNotification('Erro ao salvar feedback: ' + error.message, 'error');
        }
    }
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text)
            .then(() => showNotification('Texto copiado para a área de transferência', 'success'))
            .catch(() => showNotification('Erro ao copiar texto', 'error'));
    }

    function showTypingIndicator() {
        // Remover indicador existente se houver
        removeTypingIndicator();

        const typingDiv = document.createElement('div');
        typingDiv.className = 'message assistant';
        typingDiv.id = 'typingIndicator';
        typingDiv.innerHTML = `
        <div class="message-avatar">A1</div>
        <div class="message-content">
            <div style="display: flex; align-items: center; gap: 12px;">
                <div class="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
                <button class="action-icon-btn small" id="cancelGenerationBtn" style="margin-left: auto;">
                    <i class="fas fa-stop-circle"></i> Cancelar
                </button>
            </div>
        </div>
    `;

        // Ocultar welcome screen se estiver visível
        if (welcomeScreen.parentNode === messagesContainer) {
            welcomeScreen.style.display = 'none';
        }

        messagesContainer.appendChild(typingDiv);
        scrollToBottom();

        document.getElementById('cancelGenerationBtn').addEventListener('click', cancelGeneration);
    }

    function removeTypingIndicator() {
        const typingIndicator = document.getElementById('typingIndicator');
        if (typingIndicator) {
            typingIndicator.remove();
        }
    }

    async function sendMessageFromHistory(userMessage) {
        isGenerating = true;

        try {
            showTypingIndicator();

            const requestId = generateId();
            currentRequestId = requestId;

            await db.collection('ai_requests').doc(requestId).set({
                requestId: requestId,
                conversationId: currentConversationId,
                messageId: userMessage.id,
                userId: currentUser.uid,
                userMessage: userMessage.content,
                images: userMessage.images || [],
                model: userPreferences?.model || 'amazonia-1-standard',
                temperature: userPreferences?.temperature || 0.7,
                status: 'pending',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            // Nota: A resposta será automaticamente capturada pelo messageListener
            // Não precisamos monitorar separadamente

        } catch (error) {
            console.error('Error sending message from history:', error);
            removeTypingIndicator();
            isGenerating = false;
            currentRequestId = null;
            showNotification('Erro ao processar mensagem', 'error');
        }
    }

    function setupMessageInput() {
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            const newHeight = Math.min(this.scrollHeight, 200);
            this.style.height = newHeight + 'px';
            updateSendButtonState();
        });

        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if ((this.value.trim() || uploadedImages.length > 0) && !isGenerating && !isSending) {
                    sendMessage().catch(error => {
                        console.error('Error sending message:', error);
                        showNotification('Erro ao enviar mensagem', 'error');
                    });
                }
            }
        });
    }

    function updateSendButtonState() {
        const hasText = messageInput.value.trim().length > 0;
        const hasImages = uploadedImages.length > 0;

        if (isGenerating) {
            sendBtn.disabled = false;
            sendBtn.innerHTML = '<i class="fas fa-stop-circle"></i>';
            sendBtn.title = 'Cancelar geração';
            sendBtn.classList.add('cancel');
        } else {
            sendBtn.disabled = !(hasText || hasImages) || isSending;
            sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
            sendBtn.title = 'Enviar mensagem';
            sendBtn.classList.remove('cancel');
        }
    }


    function initializeEventListeners() {
        sendBtn.addEventListener('click', function() {
            if (isGenerating) {
                cancelGeneration().catch(error => {
                    console.error('Error cancelling generation:', error);
                    showNotification('Erro ao cancelar geração', 'error');
                });
            } else if (!isSending) {
                sendMessage().catch(error => {
                    console.error('Error sending message:', error);
                    showNotification('Erro ao enviar mensagem', 'error');
                });
            }
        });

        messageInput.addEventListener('input', function() {
            const hasText = this.value.trim().length > 0;
            const hasImages = uploadedImages.length > 0;

            if (isGenerating) {
                sendBtn.innerHTML = '<i class="fas fa-stop-circle"></i>';
                sendBtn.title = 'Cancelar geração';
                sendBtn.disabled = false;
                sendBtn.classList.add('cancel');
            } else {
                sendBtn.disabled = !(hasText || hasImages) || isSending;
                sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
                sendBtn.title = 'Enviar mensagem';
                sendBtn.classList.remove('cancel');
            }

            this.style.height = 'auto';
            const newHeight = Math.min(this.scrollHeight, 200);
            this.style.height = newHeight + 'px';
        });

        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if ((this.value.trim() || uploadedImages.length > 0) && !isGenerating && !isSending) {
                    sendMessage().catch(error => {
                        console.error('Error sending message:', error);
                        showNotification('Erro ao enviar mensagem', 'error');
                    });
                }
            }
        });

        uploadBtn.addEventListener('click', () => {
            imageUpload.value = '';
            imageUpload.click();
        });

        imageUpload.addEventListener('change', handleImageUpload);

        newChatBtn.addEventListener('click', () => {
            searchInput.value = '';
            searchConversations('');
            createNewConversation().catch(error => {
                console.error('Error creating new conversation:', error);
                showNotification('Erro ao criar nova conversa', 'error');
            });
        });

        logoutBtn.addEventListener('click', () => {
            if (confirm('Tem certeza que deseja sair?')) {
                auth.signOut().then(() => {
                    showNotification('Logout realizado com sucesso', 'success');
                }).catch(error => {
                    console.error('Error signing out:', error);
                    showNotification('Erro ao fazer logout', 'error');
                });
            }
        });

        settingsBtn.addEventListener('click', () => {
            settingsModal.classList.add('active');
        });

        closeSettings.addEventListener('click', () => {
            settingsModal.classList.remove('active');
        });

        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) {
                settingsModal.classList.remove('active');
            }
        });

        temperatureSlider.addEventListener('input', () => {
            temperatureValue.textContent = temperatureSlider.value;
        });

        contextSlider.addEventListener('input', () => {
            contextValue.textContent = contextSlider.value;
        });

        speedSlider.addEventListener('input', () => {
            const speeds = ['Lento', 'Normal', 'Rápido'];
            speedValue.textContent = speeds[speedSlider.value - 1];
        });

        imageQualitySlider.addEventListener('input', () => {
            const qualities = ['Baixa', 'Média', 'Alta'];
            imageQualityValue.textContent = qualities[imageQualitySlider.value - 1];
        });

        modelSelect.addEventListener('change', () => {
            const selectedOption = modelSelect.options[modelSelect.selectedIndex];
            modelValue.textContent = selectedOption.text;
        });

        themeSelect.addEventListener('change', () => {
            const selectedOption = themeSelect.options[themeSelect.selectedIndex];
            themeValue.textContent = selectedOption.text;
        });

        languageSelect.addEventListener('change', () => {
            const selectedOption = languageSelect.options[languageSelect.selectedIndex];
            languageValue.textContent = selectedOption.text;
        });

        saveSettings.addEventListener('click', () => {
            const newPreferences = {
                theme: themeSelect.value,
                language: languageSelect.value,
                model: modelSelect.value,
                temperature: parseFloat(temperatureSlider.value),
                contextSize: parseInt(contextSlider.value),
                responseSpeed: parseInt(speedSlider.value),
                imageQuality: parseInt(imageQualitySlider.value)
            };

            db.collection('users').doc(currentUser.uid).update({
                'preferences': newPreferences
            }).then(() => {
                userPreferences = newPreferences;
                applyTheme(newPreferences.theme);
                settingsModal.classList.remove('active');
                showNotification('Configurações salvas com sucesso!', 'success');
            }).catch(error => {
                console.error('Error saving settings:', error);
                showNotification('Erro ao salvar configurações', 'error');
            });
        });

        mobileMenuBtn.addEventListener('click', () => {
            sidebar.classList.add('active');
            sidebarOverlay.classList.add('active');
        });

        sidebarOverlay.addEventListener('click', () => {
            sidebar.classList.remove('active');
            sidebarOverlay.classList.remove('active');
        });

        searchInput.addEventListener('input', (e) => {
            searchConversations(e.target.value);
        });

        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                e.preventDefault();
                searchInput.value = '';
                searchConversations('');
                createNewConversation().catch(error => {
                    console.error('Error creating new conversation:', error);
                    showNotification('Erro ao criar nova conversa', 'error');
                });
            }

            if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
                e.preventDefault();
                regenerateLastMessage().catch(error => {
                    console.error('Error regenerating message:', error);
                    showNotification('Erro ao gerar novamente', 'error');
                });
            }

            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                searchInput.focus();
            }

            if (e.key === 'Escape') {
                if (sidebar.classList.contains('active')) {
                    sidebar.classList.remove('active');
                    sidebarOverlay.classList.remove('active');
                }
                if (settingsModal.classList.contains('active')) {
                    settingsModal.classList.remove('active');
                }
            }
        });

        window.addEventListener('resize', handleResize);
    }


    function setupAIResponseListener(requestId, userMessageId) {
        // Cancelar listener anterior se existir
        if (aiResponseListeners.has(requestId)) {
            aiResponseListeners.get(requestId)();
        }

        // Criar listener específico para esta requisição
        const unsubscribe = db.collection('ai_responses')
            .where('requestId', '==', requestId)
            .where('conversationId', '==', currentConversationId)
            .limit(1)
            .onSnapshot((snapshot) => {
                if (!snapshot.empty) {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'added') {
                            const response = change.doc.data();
                            console.log('AI Response received:', response);

                            // Processar a resposta do AI
                            processAIResponse(response, userMessageId);

                            // Remover este listener após processar
                            if (aiResponseListeners.has(requestId)) {
                                aiResponseListeners.get(requestId)();
                                aiResponseListeners.delete(requestId);
                            }
                        }
                    });
                }
            }, (error) => {
                console.error('Error listening to AI response:', error);
            });

        // Armazenar a função para cancelar o listener
        aiResponseListeners.set(requestId, unsubscribe);
    }

    async function processAIResponse(response, userMessageId) {
        try {
            removeTypingIndicator();

            if (response.status === 'completed' && response.assistantMessage) {
                const assistantMessage = {
                    role: 'assistant',
                    content: response.assistantMessage,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'sent',
                    model: response.model || userPreferences?.model || 'amazonia-1-standard',
                    requestId: response.requestId || currentRequestId
                    // NÃO incluir userId para mensagens do assistant
                };

                // Salvar a mensagem do assistant no Firestore
                const messageRef = await db.collection('conversations')
                    .doc(currentConversationId)
                    .collection('messages')
                    .add(assistantMessage);

                // Atualizar o objeto com o ID gerado
                assistantMessage.id = messageRef.id;

                // Exibir na UI
                addMessageToUI(assistantMessage, true);

                // Atualizar título da conversa se for a primeira mensagem
                if (currentChatTitle.textContent === 'Nova Conversa') {
                    // Pegar o conteúdo da última mensagem do usuário
                    const lastUserMsgSnapshot = await db.collection('conversations')
                        .doc(currentConversationId)
                        .collection('messages')
                        .where('role', '==', 'user')
                        .orderBy('timestamp', 'desc')
                        .limit(1)
                        .get();

                    if (!lastUserMsgSnapshot.empty) {
                        const lastUserContent = lastUserMsgSnapshot.docs[0].data().content || 'Pergunta sobre IA';
                        const title = lastUserContent.substring(0, 50) + (lastUserContent.length > 50 ? '...' : '');
                        currentChatTitle.textContent = title;

                        await db.collection('conversations').doc(currentConversationId).update({
                            title: title,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                }

                console.log('Resposta da IA salva e exibida com sucesso (ID:', messageRef.id, ')');

            } else if (response.status === 'error') {
                const errorMessage = {
                    role: 'assistant',
                    content: 'Desculpe, houve um erro ao gerar a resposta. Por favor, tente novamente.',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'error'
                    // NÃO incluir userId para mensagens do assistant
                };
                const errorRef = await db.collection('conversations')
                    .doc(currentConversationId)
                    .collection('messages')
                    .add(errorMessage);

                errorMessage.id = errorRef.id;
                addMessageToUI(errorMessage, true);
                showNotification('Erro na geração da resposta', 'error');
            }

        } catch (error) {
            console.error('Erro ao processar e salvar resposta do AI:', error);
            removeTypingIndicator();
            showNotification('Erro ao exibir resposta do AI: ' + error.message, 'error');
        } finally {
            isGenerating = false;
            currentRequestId = null;
            updateSendButtonState();
        }
    }
    // Corrigir a função formatTime para lidar com diferentes tipos de timestamp
    function formatTime(timestamp) {
        if (!timestamp) return '';

        let date;
        try {
            if (typeof timestamp === 'object') {
                if (timestamp.toDate) {
                    // É um Firestore Timestamp
                    date = timestamp.toDate();
                } else if (timestamp._seconds) {
                    // É um objeto com _seconds
                    date = new Date(timestamp._seconds * 1000);
                } else if (timestamp instanceof Date) {
                    // Já é um Date
                    date = timestamp;
                } else {
                    date = new Date();
                }
            } else if (typeof timestamp === 'string' || typeof timestamp === 'number') {
                // É uma string ou número
                date = new Date(timestamp);
            } else {
                date = new Date();
            }

            // Verificar se a data é válida
            if (isNaN(date.getTime())) {
                return 'Agora';
            }

            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Agora';
            if (diffMins < 60) return `${diffMins} min atrás`;
            if (diffHours < 24) return `${diffHours}h atrás`;
            if (diffDays < 7) return `${diffDays}d atrás`;

            return date.toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        } catch (error) {
            console.error('Erro ao formatar tempo:', error, timestamp);
            return 'Agora';
        }
    }
    function addMessageToUI(message, animate = true) {
        try {
            // Verificar se a mensagem já existe no DOM
            const existingMessage = document.querySelector(`.message[data-id="${message.id}"]`);
            if (existingMessage) {
                console.log('Message already in UI:', message.id);
                return;
            }

            // Verificar se já foi exibida nesta sessão
            if (displayedMessageIds.has(message.id)) {
                console.log('Message already displayed in this session:', message.id);
                return;
            }

            // Adicionar ao conjunto de IDs exibidos
            displayedMessageIds.add(message.id);

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.role}`;
            messageDiv.dataset.id = message.id;

            // CORRIGIDO: Lidar corretamente com timestamp
            let timestamp;
            try {
                if (message.timestamp && typeof message.timestamp === 'object') {
                    // É um objeto Firestore Timestamp
                    if (message.timestamp.toDate) {
                        timestamp = message.timestamp.toDate();
                    } else if (message.timestamp._seconds) {
                        // É um objeto com _seconds e _nanoseconds
                        timestamp = new Date(message.timestamp._seconds * 1000);
                    } else {
                        timestamp = new Date();
                    }
                } else if (message.timestamp) {
                    // É uma string ou número
                    timestamp = new Date(message.timestamp);
                } else {
                    timestamp = new Date();
                }
            } catch (e) {
                console.warn('Erro ao processar timestamp:', e);
                timestamp = new Date();
            }

            const time = formatTime(timestamp);
            const avatarText = message.role === 'user'
                ? (userName ? getInitials(userName.textContent) : 'Você')
                : 'A1';

            // Determinar se há conteúdo para exibir
            const hasContent = message.content && message.content.trim().length > 0;
            const hasImages = message.images && message.images.length > 0;
            const hasAudio = message.audio && message.audio.url;

            if (message.role === 'user') {
                messageDiv.innerHTML = `
                <div class="message-avatar" title="Você">${avatarText}</div>
                <div class="message-content">
                    ${hasAudio ? `
                        <div class="audio-player">
                            <audio controls src="${message.audio.url}"></audio>
                        </div>` : ''}
                    ${hasContent ? `<div class="message-text">${formatMessageContent(message.content)}</div>` : ''}
                    ${hasImages ?
                    message.images.map(img =>
                        `<img src="${img.url}" alt="${img.name}" class="message-image" loading="lazy">`
                    ).join('') : ''}
                    <div class="message-time">
                        <i class="far fa-clock"></i> ${time}
                    </div>
                </div>
            `;
            } else {
                messageDiv.innerHTML = `
                <div class="message-avatar" title="Amazônia 1 AI">${avatarText}</div>
                <div class="message-content">
                    ${hasContent ? `<div class="message-text">${formatMessageContent(message.content)}</div>` : ''}
                    ${message.status === 'error' ?
                    '<div style="color: var(--error-color); font-size: 12px; margin-top: 8px;"><i class="fas fa-exclamation-circle"></i> Erro ao processar</div>' : ''}
                    ${message.status === 'timeout' ?
                    '<div style="color: var(--warning-color); font-size: 12px; margin-top: 8px;"><i class="fas fa-clock"></i> Tempo esgotado</div>' : ''}
                    <div class="message-time">
                        <i class="far fa-clock"></i> ${time}
                    </div>
                </div>
            `;
            }

            // Remover welcome screen se estiver visível
            if (welcomeScreen.parentNode === messagesContainer) {
                welcomeScreen.style.display = 'none';
            }

            // Adicionar ao container
            messagesContainer.appendChild(messageDiv);

            // Aplicar animação se solicitado
            if (animate) {
                messageDiv.style.opacity = '0';
                messageDiv.style.transform = `translateY(${message.role === 'user' ? '10px' : '-10px'})`;

                setTimeout(() => {
                    messageDiv.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                    messageDiv.style.opacity = '1';
                    messageDiv.style.transform = 'translateY(0)';
                    scrollToBottom();
                }, 10);
            } else {
                // Sem animação, apenas scroll
                setTimeout(() => {
                    scrollToBottom();
                }, 10);
            }

            // Adicionar ações apenas se não for um indicador de digitação
            if (message.id !== 'typingIndicator') {
                addMessageActions(messageDiv, message);
            }

            // Se for uma mensagem do assistente, resetar o estado de geração
            if (message.role === 'assistant' && isGenerating) {
                isGenerating = false;
                currentRequestId = null;
                updateSendButtonState();
            }

        } catch (error) {
            console.error('Error adding message to UI:', error);
        }
    }  // Corrigir a função sendMessage para lidar melhor com a criação de conversas
    async function sendMessage() {
        if (isGenerating) {
            await cancelGeneration();
            return;
        }

        if (isSending) {
            console.log('Já está enviando mensagem...');
            return;
        }

        const text = messageInput.value.trim();
        if (!text && uploadedImages.length === 0) return;

        isSending = true;

        try {
            // Criar conversa se necessário
            if (!currentConversationId) {
                const newConvId = await createNewConversation();
                if (!newConvId) {
                    showNotification('Erro ao criar conversa', 'error');
                    isSending = false;
                    return;
                }
            }

            // Criar mensagem do usuário COM TODOS OS CAMPOS NECESSÁRIOS
            const userMessageId = generateId();
            const userMessage = {
                id: userMessageId,
                role: 'user',
                content: text || '', // Conteúdo obrigatório
                images: [],
                timestamp: firebase.firestore.FieldValue.serverTimestamp(), // Usar serverTimestamp
                userId: currentUser.uid, // userId obrigatório
                status: 'sent',
                conversationId: currentConversationId
            };

            // Upload de imagens
            for (const image of uploadedImages) {
                if (image.file) {
                    try {
                        const downloadURL = await uploadImageToStorage(image.file);
                        userMessage.images.push({
                            url: downloadURL,
                            name: image.file.name,
                            contentType: image.file.type
                        });
                    } catch (uploadError) {
                        console.error('Error uploading image:', uploadError);
                        showNotification(`Erro ao enviar imagem ${image.file.name}`, 'error');
                    }
                }
            }

            // Limpar UI
            messageInput.value = '';
            uploadedImages = [];
            imagePreview.innerHTML = '';
            messageInput.style.height = 'auto';

            // Mostrar mensagem do usuário na UI
            if (welcomeScreen.parentNode === messagesContainer) {
                welcomeScreen.style.display = 'none';
            }
            addMessageToUI(userMessage, true);

            // Salvar no Firestore COM TODOS OS CAMPOS NECESSÁRIOS
            await db.collection('conversations').doc(currentConversationId)
                .collection('messages')
                .doc(userMessageId)
                .set(userMessage);

            // Atualizar conversa
            await db.collection('conversations').doc(currentConversationId).update({
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                messageCount: firebase.firestore.FieldValue.increment(1)
            });

            // Atualizar título da conversa
            if (text && currentChatTitle.textContent === 'Nova Conversa') {
                const title = text.substring(0, 50) + (text.length > 50 ? '...' : '');
                await db.collection('conversations').doc(currentConversationId).update({
                    title: title
                });
                currentChatTitle.textContent = title;
            }

            // Preparar para resposta do AI
            isGenerating = true;
            showTypingIndicator();

            const requestId = generateId();
            currentRequestId = requestId;

            // Configurar listener para resposta
            setupAIResponseListener(requestId, userMessageId);

            // Criar requisição para AI - garantir que tenha userId
            await db.collection('ai_requests').doc(requestId).set({
                requestId: requestId,
                conversationId: currentConversationId,
                messageId: userMessageId,
                userId: currentUser.uid, // userId obrigatório
                userMessage: text || '',
                images: userMessage.images,
                model: userPreferences?.model || 'amazonia-1-standard',
                temperature: userPreferences?.temperature || 0.7,
                status: 'pending',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            // Timeout de 90 segundos
            setTimeout(() => {
                if (isGenerating && currentRequestId === requestId) {
                    console.log('Timeout: resetando estado');
                    removeTypingIndicator();
                    isGenerating = false;
                    currentRequestId = null;
                    updateSendButtonState();
                    showNotification('O tempo de resposta excedeu o limite. Tente novamente.', 'warning');

                    // Remover listener
                    if (aiResponseListeners.has(requestId)) {
                        aiResponseListeners.get(requestId)();
                        aiResponseListeners.delete(requestId);
                    }
                }
            }, 90000);

        } catch (error) {
            console.error('Error sending message:', error);
            showNotification('Erro ao enviar mensagem: ' + error.message, 'error');
            removeTypingIndicator();
            isGenerating = false;
            currentRequestId = null;
            updateSendButtonState();
        } finally {
            isSending = false;
        }
    }
    // Corrigir a função createNewConversation para evitar duplicação
    async function createNewConversation() {
        if (isCreatingConversation) {
            console.log('Aguarde, já está criando uma conversa...');

            // Esperar até que a conversa seja criada
            let waitCount = 0;
            while (isCreatingConversation && waitCount < 100) {
                await new Promise(resolve => setTimeout(resolve, 100));
                waitCount++;
            }

            // Se ainda não tiver currentConversationId após espera
            if (!currentConversationId) {
                console.error('Timeout ao criar conversa');
                showNotification('Erro ao criar conversa (timeout)', 'error');
                return null;
            }

            return currentConversationId;
        }

        try {
            isCreatingConversation = true;

            const conversationRef = await db.collection('conversations').add({
                userId: currentUser.uid,
                title: 'Nova Conversa',
                model: userPreferences?.model || 'amazonia-1-standard',
                status: 'active',
                favorite: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                messageCount: 0
            });

            currentConversationId = conversationRef.id;

            // Atualizar UI
            messagesContainer.innerHTML = '';
            welcomeScreen.style.display = 'flex';
            messagesContainer.appendChild(welcomeScreen);
            currentChatTitle.textContent = 'Nova Conversa';

            uploadedImages = [];
            imagePreview.innerHTML = '';
            displayedMessageIds.clear();

            updateActiveConversation();
            messageInput.focus();

            console.log('Nova conversa criada:', conversationRef.id);
            return conversationRef.id;
        } catch (error) {
            console.error('Error creating conversation:', error);
            showNotification('Erro ao criar conversa', 'error');
            return null;
        } finally {
            isCreatingConversation = false;
        }
    }

    // Adicionar esta função para evitar múltiplas inicializações
    function safeToDate(timestamp) {
        try {
            if (timestamp && typeof timestamp === 'object' && timestamp.toDate) {
                return timestamp.toDate();
            }
            return new Date(timestamp);
        } catch (e) {
            console.warn('Erro ao converter timestamp:', e);
            return new Date();
        }
    }

    async function loadConversations() {
        try {
            console.log('loadConversations: Iniciando carregamento...', currentUser.uid);

            // Limpar listener anterior se existir
            if (conversationsListener) {
                console.log('loadConversations: Removendo listener anterior');
                conversationsListener();
                conversationsListener = null;
            }

            // Limpar lista atual
            conversationsList.innerHTML = '';

            // Mostrar estado vazio inicial
            emptyConversations.style.display = 'flex';
            noResults.style.display = 'none';

            // Pequeno delay para evitar conflitos
            await new Promise(resolve => setTimeout(resolve, 100));

            // Verificar se o usuário está autenticado
            if (!currentUser || !currentUser.uid) {
                console.error('loadConversations: Usuário não autenticado');
                return;
            }

            console.log('loadConversations: Configurando listener para usuário:', currentUser.uid);

            // Criar listener para conversas
            conversationsListener = db.collection('conversations')
                .where('userId', '==', currentUser.uid)
                .orderBy('updatedAt', 'desc')
                .onSnapshot(async (snapshot) => {
                    try {
                        console.log('loadConversations: Snapshot recebido -', snapshot.size, 'conversas');

                        // Limpar lista atual
                        conversationsList.innerHTML = '';

                        if (snapshot.empty) {
                            console.log('loadConversations: Nenhuma conversa encontrada');
                            emptyConversations.style.display = 'flex';
                            noResults.style.display = 'none';
                            initialLoadComplete = true;
                            return;
                        }

                        // Esconder estado vazio
                        emptyConversations.style.display = 'none';
                        noResults.style.display = 'none';

                        // Processar conversas
                        const conversations = [];
                        snapshot.forEach(doc => {
                            try {
                                const data = doc.data();
                                conversations.push({
                                    id: doc.id,
                                    ...data
                                });
                                console.log('loadConversations: Conversa encontrada -', doc.id, data.title);
                            } catch (error) {
                                console.error('loadConversations: Erro ao processar documento:', doc.id, error);
                            }
                        });

                        console.log('loadConversations: Total de conversas processadas:', conversations.length);

                        // Ordenar: favoritos primeiro, depois por data
                        conversations.sort((a, b) => {
                            try {
                                // Favoritos primeiro
                                if (a.favorite && !b.favorite) return -1;
                                if (!a.favorite && b.favorite) return 1;

                                // Depois por data mais recente
                                let timeA, timeB;

                                try {
                                    timeA = a.updatedAt?.toDate ? a.updatedAt.toDate() :
                                        new Date(a.updatedAt?._seconds * 1000 || a.updatedAt || 0);
                                } catch (e) {
                                    timeA = new Date(0);
                                }

                                try {
                                    timeB = b.updatedAt?.toDate ? b.updatedAt.toDate() :
                                        new Date(b.updatedAt?._seconds * 1000 || b.updatedAt || 0);
                                } catch (e) {
                                    timeB = new Date(0);
                                }

                                return timeB.getTime() - timeA.getTime();
                            } catch (error) {
                                console.error('loadConversations: Erro ao ordenar conversas:', error);
                                return 0;
                            }
                        });

                        // Adicionar cada conversa à UI
                        conversations.forEach(conversation => {
                            try {
                                addConversationToUI(conversation.id, conversation);
                            } catch (error) {
                                console.error('loadConversations: Erro ao adicionar conversa à UI:', conversation.id, error);
                            }
                        });

                        console.log('loadConversations: Conversas adicionadas à UI:', conversationsList.children.length);

                        // Atualizar conversa ativa se houver uma selecionada
                        updateActiveConversation();

                        initialLoadComplete = true;

                    } catch (snapshotError) {
                        console.error('loadConversations: Erro no snapshot:', snapshotError);
                        emptyConversations.style.display = 'flex';
                        noResults.style.display = 'none';
                    }
                }, (error) => {
                    console.error('loadConversations: Erro no listener:', error);

                    if (error.code === 'failed-precondition') {
                        console.warn('loadConversations: Índice não criado ainda. Tentando carregar sem ordenação...');

                        // Fallback: carregar sem ordenação
                        db.collection('conversations')
                            .where('userId', '==', currentUser.uid)
                            .get()
                            .then((snapshot) => {
                                console.log('loadConversations: Fallback -', snapshot.size, 'conversas');

                                if (snapshot.empty) {
                                    emptyConversations.style.display = 'flex';
                                    noResults.style.display = 'none';
                                    return;
                                }

                                emptyConversations.style.display = 'none';
                                noResults.style.display = 'none';

                                const conversations = [];
                                snapshot.forEach(doc => {
                                    const data = doc.data();
                                    conversations.push({
                                        id: doc.id,
                                        ...data
                                    });
                                });

                                // Ordenar localmente por data
                                conversations.sort((a, b) => {
                                    let timeA, timeB;

                                    try {
                                        timeA = a.updatedAt?.toDate ? a.updatedAt.toDate() :
                                            new Date(a.updatedAt?._seconds * 1000 || a.updatedAt || 0);
                                    } catch (e) {
                                        timeA = new Date(0);
                                    }

                                    try {
                                        timeB = b.updatedAt?.toDate ? b.updatedAt.toDate() :
                                            new Date(b.updatedAt?._seconds * 1000 || b.updatedAt || 0);
                                    } catch (e) {
                                        timeB = new Date(0);
                                    }

                                    return timeB.getTime() - timeA.getTime();
                                });

                                conversations.forEach(conversation => {
                                    addConversationToUI(conversation.id, conversation);
                                });

                                updateActiveConversation();
                            })
                            .catch((fallbackError) => {
                                console.error('loadConversations: Erro no fallback:', fallbackError);
                                showNotification('Erro ao carregar conversas', 'error');
                            });

                    } else if (error.code === 'permission-denied') {
                        console.error('loadConversations: Permissão negada. Verifique as regras de segurança.');
                        showNotification('Permissão negada para acessar conversas', 'error');
                    } else {
                        showNotification('Erro ao carregar conversas: ' + error.message, 'error');
                    }
                });

            console.log('loadConversations: Listener configurado com sucesso');

        } catch (error) {
            console.error('loadConversations: Erro geral:', error);
            showNotification('Erro ao carregar conversas', 'error');
        }
    }

    // Adicione esta função para limpar tudo ao fazer logout
    logoutBtn.addEventListener('click', () => {
        if (confirm('Tem certeza que deseja sair?')) {
            // Limpar todos os listeners
            if (messageListener) messageListener();
            if (conversationsListener) conversationsListener();
            aiResponseListeners.forEach(unsubscribe => unsubscribe());
            aiResponseListeners.clear();

            auth.signOut().then(() => {
                showNotification('Logout realizado com sucesso', 'success');
            }).catch(error => {
                console.error('Error signing out:', error);
                showNotification('Erro ao fazer logout', 'error');
            });
        }
    });


    // Adicione esta função para limpar tudo ao fazer logout
    logoutBtn.addEventListener('click', () => {
        if (confirm('Tem certeza que deseja sair?')) {
            // Limpar todos os listeners
            if (messageListener) messageListener();
            if (conversationsListener) conversationsListener();
            aiResponseListeners.forEach(unsubscribe => unsubscribe());
            aiResponseListeners.clear();

            auth.signOut().then(() => {
                showNotification('Logout realizado com sucesso', 'success');
            }).catch(error => {
                console.error('Error signing out:', error);
                showNotification('Erro ao fazer logout', 'error');
            });
        }
    });

    window.handleFeedback = handleFeedback;
    window.regenerateLastMessage = regenerateLastMessage;
    window.copyToClipboard = copyToClipboard;
</script>

</body>
</html>
